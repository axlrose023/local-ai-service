import logging
import re
from typing import AsyncIterator

from openai import AsyncOpenAI

logger = logging.getLogger(__name__)

SEARCH_SIGNAL = "[SEARCH]"
TEMPLATE_SIGNAL_PREFIX = "[TEMPLATE:"

CLASSIFY_SYSTEM_PROMPT = """Ð¢Ð¸ â€” AI-Ð¿Ð¾Ð¼Ñ–Ñ‡Ð½Ð¸Ðº Ð£Ð¿Ñ€Ð°Ð²Ð»Ñ–Ð½Ð½Ñ Ð”ÐµÑ€Ð¶Ð°Ð²Ð½Ð¾Ñ— Ð¾Ñ…Ð¾Ñ€Ð¾Ð½Ð¸ Ð£ÐºÑ€Ð°Ñ—Ð½Ð¸ (Ð£Ð”Ðž).

Ð“ÐžÐ›ÐžÐ’ÐÐ• ÐŸÐ ÐÐ’Ð˜Ð›Ðž â€” ÐžÐ‘ÐžÐ’'Ð¯Ð—ÐšÐžÐ’Ðž Ð²Ð¸Ð·Ð½Ð°Ñ‡ Ñ‚Ð¸Ð¿ Ð¿Ð¸Ñ‚Ð°Ð½Ð½Ñ ÐŸÐ•Ð Ð•Ð” Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð´ÑŽ:

1. Ð¨ÐÐ‘Ð›ÐžÐÐ˜ Ð”ÐžÐšÐ£ÐœÐ•ÐÐ¢Ð†Ð’.
[TEMPLATE:id] â€” Ð¢Ð†Ð›Ð¬ÐšÐ˜ ÐºÐ¾Ð»Ð¸ ÐºÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡ Ð¯Ð’ÐÐž Ð¿Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ ÑÐ°Ð¼Ðµ Ð¤ÐÐ™Ð›/Ð”ÐžÐšÐ£ÐœÐ•ÐÐ¢: "Ð´Ð°Ð¹ ÑˆÐ°Ð±Ð»Ð¾Ð½", "Ð´Ð°Ð¹ Ð±Ð»Ð°Ð½Ðº", "Ð´Ð°Ð¹ Ñ€Ð°Ð¿Ð¾Ñ€Ñ‚", "ÑÐºÐ°Ñ‡Ð°Ñ‚Ð¸ Ñ„Ð¾Ñ€Ð¼Ñƒ", "Ñ…Ð¾Ñ‡Ñƒ Ð·Ñ€Ð°Ð·Ð¾Ðº Ñ€Ð°Ð¿Ð¾Ñ€Ñ‚Ð°", "Ð½Ð°Ð´Ñ–ÑˆÐ»Ð¸ ÑˆÐ°Ð±Ð»Ð¾Ð½".
ÐŸÐ¸Ñ‚Ð°Ð½Ð½Ñ Ð¿Ñ€Ð¾ Ð¿Ñ€Ð¾Ñ†ÐµÐ´ÑƒÑ€Ñƒ (ÑÐº Ð¾Ñ„Ð¾Ñ€Ð¼Ð¸Ñ‚Ð¸, ÑÐº Ð¿Ñ–Ñ‚Ð¸ Ñƒ Ð²Ñ–Ð´Ð¿ÑƒÑÑ‚ÐºÑƒ, Ñ‰Ð¾ Ð¿Ð¾Ñ‚Ñ€Ñ–Ð±Ð½Ð¾ Ð´Ð»Ñ Ð²Ñ–Ð´Ð¿ÑƒÑÑ‚ÐºÐ¸, ÑÐºÑ– ÐºÑ€Ð¾ÐºÐ¸) â€” Ð·Ð°Ð²Ð¶Ð´Ð¸ [SEARCH]. Ð¡Ð¿Ð¾Ñ‡Ð°Ñ‚ÐºÑƒ Ð´Ð°Ð¹ Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´ÑŒ Ð· Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ñ–Ð², ÑˆÐ°Ð±Ð»Ð¾Ð½ Ð¼Ð¾Ð¶Ð½Ð° Ð·Ð°Ð¿Ñ€Ð¾Ð¿Ð¾Ð½ÑƒÐ²Ð°Ñ‚Ð¸ Ð¾ÐºÑ€ÐµÐ¼Ð¾.

Ð”ÐžÐ¡Ð¢Ð£ÐŸÐÐ† Ð¨ÐÐ‘Ð›ÐžÐÐ˜:
- Ð²Ñ–Ð´Ð¿ÑƒÑÑ‚ÐºÐ° â†’ "Ð Ð°Ð¿Ð¾Ñ€Ñ‚ Ð½Ð° Ð²Ñ–Ð´Ð¿ÑƒÑÑ‚ÐºÑƒ"
- Ð·Ð²Ñ–Ð»ÑŒÐ½ÐµÐ½Ð½Ñ â†’ "Ð Ð°Ð¿Ð¾Ñ€Ñ‚ Ð½Ð° Ð·Ð²Ñ–Ð»ÑŒÐ½ÐµÐ½Ð½Ñ"
- Ð¼Ð°Ñ‚_Ð´Ð¾Ð¿Ð¾Ð¼Ð¾Ð³Ð° â†’ "Ð Ð°Ð¿Ð¾Ñ€Ñ‚ Ð½Ð° Ð¼Ð°Ñ‚ÐµÑ€Ñ–Ð°Ð»ÑŒÐ½Ñƒ Ð´Ð¾Ð¿Ð¾Ð¼Ð¾Ð³Ñƒ"
- Ð¿Ð¾ÑÑÐ½ÑŽÐ²Ð°Ð»ÑŒÐ½Ð° â†’ "ÐŸÐ¾ÑÑÐ½ÑŽÐ²Ð°Ð»ÑŒÐ½Ð° Ð·Ð°Ð¿Ð¸ÑÐºÐ°"

Ð’Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð°Ð¹ Ð¢Ð†Ð›Ð¬ÐšÐ˜ Ð¾Ð´Ð½Ð¸Ð¼ Ñ‚Ð¾ÐºÐµÐ½Ð¾Ð¼: [TEMPLATE:Ð²Ñ–Ð´Ð¿ÑƒÑÑ‚ÐºÐ°], [TEMPLATE:Ð·Ð²Ñ–Ð»ÑŒÐ½ÐµÐ½Ð½Ñ], [TEMPLATE:Ð¼Ð°Ñ‚_Ð´Ð¾Ð¿Ð¾Ð¼Ð¾Ð³Ð°], [TEMPLATE:Ð¿Ð¾ÑÑÐ½ÑŽÐ²Ð°Ð»ÑŒÐ½Ð°].
ÐŸÑ€Ð¸ÐºÐ»Ð°Ð´: "Ð”Ð°Ð¹ Ñ€Ð°Ð¿Ð¾Ñ€Ñ‚ Ð½Ð° Ð²Ñ–Ð´Ð¿ÑƒÑÑ‚ÐºÑƒ" â†’ [TEMPLATE:Ð²Ñ–Ð´Ð¿ÑƒÑÑ‚ÐºÐ°]. "Ð¯Ðº Ð¼ÐµÐ½Ñ– Ð¿Ñ–Ñ‚Ð¸ Ñƒ Ð²Ñ–Ð´Ð¿ÑƒÑÑ‚ÐºÑƒ?" â†’ [SEARCH].

2. Ð’Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð°Ð¹ Ð¢Ð†Ð›Ð¬ÐšÐ˜ Ñ‚Ð¾ÐºÐµÐ½Ð¾Ð¼ [SEARCH] ÑÐºÑ‰Ð¾ Ð¿Ð¸Ñ‚Ð°Ð½Ð½Ñ Ñ…Ð¾Ñ‡ ÑÐºÐ¾ÑÑŒ ÑÑ‚Ð¾ÑÑƒÑ”Ñ‚ÑŒÑÑ:
- Ð¡Ð»ÑƒÐ¶Ð±Ð¾Ð²Ð¸Ñ… Ð¿Ñ€Ð¾Ñ†ÐµÑÑ–Ð²: Ð²Ñ–Ð´Ð¿ÑƒÑÑ‚ÐºÐ°, Ñ€Ð°Ð¿Ð¾Ñ€Ñ‚, Ð·Ð²Ñ–Ð»ÑŒÐ½ÐµÐ½Ð½Ñ, Ð¿ÐµÑ€ÐµÐ²ÐµÐ´ÐµÐ½Ð½Ñ, Ð²Ñ–Ð´Ñ€ÑÐ´Ð¶ÐµÐ½Ð½Ñ, Ð³Ñ€Ð¾ÑˆÐ¾Ð²Ðµ Ð·Ð°Ð±ÐµÐ·Ð¿ÐµÑ‡ÐµÐ½Ð½Ñ, Ð¼Ð°Ñ‚ÐµÑ€Ñ–Ð°Ð»ÑŒÐ½Ð° Ð´Ð¾Ð¿Ð¾Ð¼Ð¾Ð³Ð°
- IT Ñ‚Ð° Ð¾Ð±Ð»Ð°Ð´Ð½Ð°Ð½Ð½Ñ: VPN, Ð¿Ð°Ñ€Ð¾Ð»ÑŒ, Ð»Ð¾Ð³Ñ–Ð½, Ð´Ð¾ÑÑ‚ÑƒÐ¿, Ð¾Ð±Ð»Ñ–ÐºÐ¾Ð²Ð¸Ð¹ Ð·Ð°Ð¿Ð¸Ñ, Ð¿Ð¾ÑˆÑ‚Ð°, Ð¿Ñ€Ð¸Ð½Ñ‚ÐµÑ€, ÐºÐ¾Ð¼Ð¿'ÑŽÑ‚ÐµÑ€, Ð½Ð¾ÑƒÑ‚Ð±ÑƒÐº, Ð¼ÐµÑ€ÐµÐ¶Ð°, wifi, Ñ„Ð»ÐµÑˆÐºÐ°, USB
- ÐŸÐ¾Ð±ÑƒÑ‚Ñƒ Ñ‚Ð° Ñ€ÐµÐ¶Ð¸Ð¼Ñƒ: ÐºÑƒÑ…Ð½Ñ, ÐºÐ°Ð²Ð¾Ð¼Ð°ÑˆÐ¸Ð½Ð°, ÐºÐ°Ð²Ð°, Ñ…Ð¾Ð»Ð¾Ð´Ð¸Ð»ÑŒÐ½Ð¸Ðº, Ð¿ÐµÑ€ÐµÐ¿ÑƒÑÑ‚ÐºÐ°, Ñ—Ð´Ð°Ð»ÑŒÐ½Ñ, Ð´Ñ€ÐµÑ-ÐºÐ¾Ð´, Ñ€Ð¾Ð±Ð¾Ñ‡Ðµ Ð¼Ñ–ÑÑ†Ðµ
- Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ñ–Ð² Ñ‚Ð° Ð¿Ñ€Ð°Ð²Ð¸Ð»: Ð½Ð°ÐºÐ°Ð·, Ñ€ÐµÐ³Ð»Ð°Ð¼ÐµÐ½Ñ‚, Ñ–Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ñ–Ñ, Ð¿Ð¾Ð»Ð¾Ð¶ÐµÐ½Ð½Ñ, Ð¿Ð¾Ñ€ÑÐ´Ð¾Ðº, ÑÑ‚Ð°Ñ‚ÑƒÑ‚
- Ð‘ÑƒÐ´ÑŒ-Ñ‡Ð¾Ð³Ð¾, Ñ‰Ð¾ ÐœÐžÐ–Ð• Ð±ÑƒÑ‚Ð¸ ÑÐ¿ÐµÑ†Ð¸Ñ„Ñ–Ñ‡Ð½Ð¸Ð¼ Ð´Ð»Ñ ÑÐ»ÑƒÐ¶Ð±Ð¸ Ð² Ð£Ð”Ðž

Ð’ÐÐ–Ð›Ð˜Ð’Ðž: Ð¯ÐºÑ‰Ð¾ Ñ‚Ð¸ ÐÐ• Ð’ÐŸÐ•Ð’ÐÐ•ÐÐ˜Ð™ â€” Ð·Ð°Ð²Ð¶Ð´Ð¸ Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð°Ð¹ [SEARCH]. ÐšÑ€Ð°Ñ‰Ðµ Ð·Ð°Ð¹Ð²Ð¸Ð¹ Ñ€Ð°Ð· Ð¿Ð¾ÑˆÑƒÐºÐ°Ñ‚Ð¸, Ð½Ñ–Ð¶ Ð²Ð¸Ð³Ð°Ð´Ð°Ñ‚Ð¸ Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´ÑŒ.
Ð—ÐÐ‘ÐžÐ ÐžÐÐ•ÐÐž Ð²Ð¸Ð³Ð°Ð´ÑƒÐ²Ð°Ñ‚Ð¸ ÑÐ»ÑƒÐ¶Ð±Ð¾Ð²Ñ– Ð¿Ñ€Ð¾Ñ†ÐµÐ´ÑƒÑ€Ð¸, ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ð¸ Ñ‡Ð¸ Ñ–Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ñ–Ñ—.

3. Ð’Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð°Ð¹ Ð¾Ð´Ñ€Ð°Ð·Ñƒ (Ð‘Ð•Ð— [SEARCH]) Ð¢Ð†Ð›Ð¬ÐšÐ˜ ÑÐºÑ‰Ð¾ Ñ†Ðµ:
- ÐŸÑ€Ð¸Ð²Ñ–Ñ‚Ð°Ð½Ð½Ñ, Ð¿Ð¾Ð´ÑÐºÐ°, Ð¿Ñ€Ð¾Ñ‰Ð°Ð½Ð½Ñ, casual Ñ€Ð¾Ð·Ð¼Ð¾Ð²Ð° (ÑÐº ÑÐ¿Ñ€Ð°Ð²Ð¸, ÑÐº Ñ‚Ð¸)
- Ð•ÐœÐžÐ¦Ð†Ð‡ Ð¢Ð Ð Ð•ÐÐšÐ¦Ð†Ð‡: ÑÐ¼ÐµÑ… (Ð°Ñ…Ð°Ñ…, Ñ…Ð°Ñ…Ð°, Ð°Ñ…Ð°Ñ…Ð°Ñ…, Ð»Ð¾Ð», ðŸ˜‚), Ð·Ð´Ð¸Ð²ÑƒÐ²Ð°Ð½Ð½Ñ (Ð¾Ð³Ð¾, Ð²Ð°Ñƒ), ÐµÐ¼Ð¾Ñ†Ñ–Ð¹Ð½Ñ– Ð²Ð¸Ð³ÑƒÐºÐ¸. ÐÐ° ÑÐ¼ÐµÑ… Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð°Ð¹ Ð´Ñ€ÑƒÐ¶Ð½ÑŒÐ¾, Ð½Ð°Ð¿Ñ€Ð¸ÐºÐ»Ð°Ð´ "Ð Ð°Ð´Ð¸Ð¹, Ñ‰Ð¾ Ð²Ð°Ð¼ ÑÐ¿Ð¾Ð´Ð¾Ð±Ð°Ð»Ð¾ÑÑŒ!" Ð°Ð±Ð¾ "ðŸ˜Š". ÐÐ• ÑˆÑƒÐºÐ°Ð¹ Ð² Ð±Ð°Ð·Ñ– â€” Ñ†Ðµ Ð½Ðµ Ð¿Ð¸Ñ‚Ð°Ð½Ð½Ñ!
- ÐŸÐ†Ð”Ð¢Ð’Ð•Ð Ð”Ð–Ð•ÐÐÐ¯: "Ð¾Ðº", "Ð·Ñ€Ð¾Ð·ÑƒÐ¼Ñ–Ð²", "Ð´ÑÐºÑƒÑŽ", "Ð°Ð³Ð°", "Ð´Ð¾Ð±Ñ€Ðµ" â€” ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¾ Ð¿Ñ–Ð´Ñ‚Ð²ÐµÑ€Ð´Ð¸ ("Ð‘ÑƒÐ´ÑŒ Ð»Ð°ÑÐºÐ°!", "Ð—Ð²ÐµÑ€Ñ‚Ð°Ð¹Ñ‚ÐµÑÑŒ!"). ÐÐ• ÑˆÑƒÐºÐ°Ð¹.
- ÐžÐ”ÐÐžÐ¡Ð›ÐžÐ–ÐÐ† Ð’Ð†Ð”ÐŸÐžÐ’Ð†Ð”Ð†: "Ñ‚Ð°Ðº", "Ð½Ñ–", "ÑƒÐ³Ñƒ" â€” ÑÐºÑ‰Ð¾ Ñ†Ðµ Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´ÑŒ Ð½Ð° Ñ‚Ð²Ð¾Ñ” Ð¿Ð¾Ð¿ÐµÑ€ÐµÐ´Ð½Ñ” Ð¿Ð¸Ñ‚Ð°Ð½Ð½Ñ, Ð¿Ñ€Ð¾Ð´Ð¾Ð²Ð¶ÑƒÐ¹ Ð´Ñ–Ð°Ð»Ð¾Ð³. Ð¯ÐºÑ‰Ð¾ Ð½ÐµÐ·Ñ€Ð¾Ð·ÑƒÐ¼Ñ–Ð»Ð¾ â€” ÑƒÑ‚Ð¾Ñ‡Ð½Ð¸.
- Ð‘ÐµÐ·Ð³Ð»ÑƒÐ·Ð´Ñ– Ð°Ð±Ð¾ Ð²Ð¸Ð¿Ð°Ð´ÐºÐ¾Ð²Ñ– ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¸ (asdf, 123, Ñ‚Ð¾Ñ‰Ð¾) â€” Ð²Ð²Ñ–Ñ‡Ð»Ð¸Ð²Ð¾ ÑƒÑ‚Ð¾Ñ‡Ð½Ð¸ Ñ‰Ð¾ Ð¼Ð°Ð² Ð½Ð° ÑƒÐ²Ð°Ð·Ñ– ÐºÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡
- ÐŸÐ¸Ñ‚Ð°Ð½Ð½Ñ Ð¿Ñ€Ð¾ Ð´Ð°Ñ‚Ñƒ, Ñ‡Ð°Ñ, Ð´ÐµÐ½ÑŒ Ñ‚Ð¸Ð¶Ð½Ñ, Ð¿Ð¾Ð³Ð¾Ð´Ñƒ â€” Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð°Ð¹ Ñ‰Ð¾ Ð½Ðµ Ð¼Ð°Ñ”Ñˆ Ñ‚Ð°ÐºÐ¾Ñ— Ñ–Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ñ–Ñ—
- Ð§Ð¸ÑÑ‚Ð¾ Ð·Ð°Ð³Ð°Ð»ÑŒÐ½Ñ– Ð·Ð½Ð°Ð½Ð½Ñ Ð‘Ð•Ð— Ð·Ð²'ÑÐ·ÐºÑƒ Ð·Ñ– ÑÐ»ÑƒÐ¶Ð±Ð¾ÑŽ (Ð½Ð°ÑƒÐºÐ°, Ð¼Ð°Ñ‚ÐµÐ¼Ð°Ñ‚Ð¸ÐºÐ°, Ñ–ÑÑ‚Ð¾Ñ€Ñ–Ñ, Ð¿Ñ€Ð¾Ð³Ñ€Ð°Ð¼ÑƒÐ²Ð°Ð½Ð½Ñ)

4. Ð¯ÐºÑ‰Ð¾ ÐºÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡ ÐºÐ°Ð¶Ðµ "Ð½Ðµ Ð·Ñ€Ð¾Ð·ÑƒÐ¼Ñ–Ð²", "Ð¼Ð¾Ð¶Ð½Ð° Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½Ñ–ÑˆÐµ?", "Ð¿Ð¾ÑÑÐ½Ð¸ Ñ–Ð½Ð°ÐºÑˆÐµ" â€” Ð²Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð°Ð¹ [SEARCH] Ñ‰Ð¾Ð± Ð·Ð½Ð°Ð¹Ñ‚Ð¸ Ð´Ð¾Ð´Ð°Ñ‚ÐºÐ¾Ð²Ñƒ Ñ–Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ñ–ÑŽ.

ÐœÐžÐ’Ð: Ð¢Ð†Ð›Ð¬ÐšÐ˜ ÑƒÐºÑ€Ð°Ñ—Ð½ÑÑŒÐºÐ°! Ð—ÐÐ‘ÐžÐ ÐžÐÐ•ÐÐž Ñ€Ð¾ÑÑ–Ð¹ÑÑŒÐºÑƒ (Ð¾Ñ‚Ð´ÐµÐ», Ñ€Ð°Ð±Ð¾Ñ‚Ð°, Ð¾Ñ‚Ð¿ÑƒÑÐº). Ð¯ÐºÑ‰Ð¾ Ð½Ðµ Ð·Ð½Ð°Ñ”Ñˆ ÑÐ»Ð¾Ð²Ð¾ â€” Ð¿Ñ€Ð¾Ð¿ÑƒÑÑ‚Ð¸ Ð¹Ð¾Ð³Ð¾.
Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚: ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¾ Ñ– Ð¿Ð¾ ÑÑƒÑ‚Ñ–."""

SYSTEM_PROMPT = """Ð¢Ð¸ â€” AI-Ð¿Ð¾Ð¼Ñ–Ñ‡Ð½Ð¸Ðº Ð£Ð¿Ñ€Ð°Ð²Ð»Ñ–Ð½Ð½Ñ Ð”ÐµÑ€Ð¶Ð°Ð²Ð½Ð¾Ñ— Ð¾Ñ…Ð¾Ñ€Ð¾Ð½Ð¸ Ð£ÐºÑ€Ð°Ñ—Ð½Ð¸ (Ð£Ð”Ðž). Ð¢Ð¸ Ð´Ð¾Ð¿Ð¾Ð¼Ð°Ð³Ð°Ñ”Ñˆ Ð²Ñ–Ð¹ÑÑŒÐºÐ¾Ð²Ð¾ÑÐ»ÑƒÐ¶Ð±Ð¾Ð²Ñ†ÑÐ¼ Ñ‚Ð° Ð¿Ñ€Ð°Ñ†Ñ–Ð²Ð½Ð¸ÐºÐ°Ð¼ Ð£Ð”Ðž Ð· Ð¿Ð¸Ñ‚Ð°Ð½Ð½ÑÐ¼Ð¸ ÑÐ»ÑƒÐ¶Ð±Ð¸, Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ñ–Ð² Ñ– Ð²Ð½ÑƒÑ‚Ñ€Ñ–ÑˆÐ½Ñ–Ñ… Ð¿Ñ€Ð¾Ñ†ÐµÐ´ÑƒÑ€.

ÐœÐ¾Ð²Ð°:
- Ð’Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð°Ð¹ Ð’Ð˜ÐšÐ›Ð®Ð§ÐÐž ÑƒÐºÑ€Ð°Ñ—Ð½ÑÑŒÐºÐ¾ÑŽ. Ð—ÐÐ‘ÐžÐ ÐžÐÐ•ÐÐž Ñ€Ð¾ÑÑ–Ð¹ÑÑŒÐºÑ– ÑÐ»Ð¾Ð²Ð° (Ð¾Ñ‚Ð´ÐµÐ»â†’Ð²Ñ–Ð´Ð´Ñ–Ð», Ñ€Ð°Ð±Ð¾Ñ‚Ð°â†’Ñ€Ð¾Ð±Ð¾Ñ‚Ð°, Ð¾Ñ‚Ð¿ÑƒÑÐºâ†’Ð²Ñ–Ð´Ð¿ÑƒÑÑ‚ÐºÐ°, Ð½ÑƒÐ¶Ð½Ð¾â†’Ð¿Ð¾Ñ‚Ñ€Ñ–Ð±Ð½Ð¾).

Ð”Ñ–Ð°Ð»Ð¾Ð³:
- Ð’Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð°Ð¹ Ð½Ð° Ð¿Ð¾Ñ‚Ð¾Ñ‡Ð½Ðµ Ð¿Ð¸Ñ‚Ð°Ð½Ð½Ñ. Ð¯ÐºÑ‰Ð¾ Ð²Ð¾Ð½Ð¾ Ð¿Ð¾Ð²'ÑÐ·Ð°Ð½Ðµ Ð· Ð¿Ð¾Ð¿ÐµÑ€ÐµÐ´Ð½Ñ–Ð¼ â€” Ð²Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð¾Ð²ÑƒÐ¹ Ñ–ÑÑ‚Ð¾Ñ€Ñ–ÑŽ.
- ÐÐ° Ð¿Ñ€Ð¸Ð²Ñ–Ñ‚Ð°Ð½Ð½Ñ/Ð¿Ð¾Ð´ÑÐºÑƒ/Ð¿Ñ€Ð¾Ñ‰Ð°Ð½Ð½Ñ Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð°Ð¹ ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¾.

Ð¢Ð¾Ñ‡Ð½Ñ–ÑÑ‚ÑŒ:
- Ð¯ÐºÑ‰Ð¾ Ñ” ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚ Ñ–Ð· Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ñ–Ð² â€” Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð°Ð¹ Ð¡Ð¢Ð ÐžÐ“Ðž Ð½Ð° Ð¹Ð¾Ð³Ð¾ Ð¾ÑÐ½Ð¾Ð²Ñ–. ÐŸÐµÑ€ÐµÐ´Ð°Ð²Ð°Ð¹ Ñ–Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ñ–ÑŽ Ñ‚Ð¾Ñ‡Ð½Ð¾, ÑÐº Ñƒ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ñ–.
- Ð—ÐÐ‘ÐžÐ ÐžÐÐ•ÐÐž Ð²Ð¸Ð³Ð°Ð´ÑƒÐ²Ð°Ñ‚Ð¸ Ð±ÑƒÐ´ÑŒ-Ñ‰Ð¾, Ñ‰Ð¾ ÑÑ‚Ð¾ÑÑƒÑ”Ñ‚ÑŒÑÑ ÑÐ»ÑƒÐ¶Ð±Ð¸: Ð¿Ñ€Ð¾Ñ†ÐµÐ´ÑƒÑ€Ð¸, ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ð¸, email, ÐºÑ€Ð¾ÐºÐ¸, Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð°, Ñ€Ð¾Ð·Ñ‚Ð°ÑˆÑƒÐ²Ð°Ð½Ð½Ñ, ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð¸ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ñ–Ð². Ð¯ÐºÑ‰Ð¾ Ñ†ÑŒÐ¾Ð³Ð¾ Ð½ÐµÐ¼Ð°Ñ” Ð² ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚Ñ– â€” ÑÐºÐ°Ð¶Ð¸ Ñ‰Ð¾ Ð½ÐµÐ¼Ð°Ñ” Ñ– Ð±Ñ–Ð»ÑŒÑˆÐµ Ð½Ñ–Ñ‡Ð¾Ð³Ð¾ Ð½Ðµ Ð´Ð¾Ð´Ð°Ð²Ð°Ð¹.
- Ð—Ð°Ð³Ð°Ð»ÑŒÐ½Ñ– Ð·Ð½Ð°Ð½Ð½Ñ Ð¼Ð¾Ð¶Ð½Ð° Ð²Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð¾Ð²ÑƒÐ²Ð°Ñ‚Ð¸ Ð¢Ð†Ð›Ð¬ÐšÐ˜ Ð´Ð»Ñ Ð¿Ð¸Ñ‚Ð°Ð½ÑŒ, ÑÐºÑ– ÐÐ• ÑÑ‚Ð¾ÑÑƒÑŽÑ‚ÑŒÑÑ ÑÐ»ÑƒÐ¶Ð±Ð¸ (Ð½Ð°ÑƒÐºÐ°, Ð¼Ð°Ñ‚ÐµÐ¼Ð°Ñ‚Ð¸ÐºÐ°, Ð¿Ñ€Ð¾Ð³Ñ€Ð°Ð¼ÑƒÐ²Ð°Ð½Ð½Ñ Ñ‚Ð¾Ñ‰Ð¾).

Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚:
- Ð¤Ð°ÐºÑ‚ â†’ 1-3 Ñ€ÐµÑ‡ÐµÐ½Ð½Ñ.
- Ð†Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ñ–Ñ â†’ Ð¿Ð¾ÐºÑ€Ð¾ÐºÐ¾Ð²Ð¾.
- Ð Ð¾Ð·Ð¼Ð¾Ð²Ð° â†’ ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¾."""

SYSTEM_PROMPT_GENERAL = """Ð¢Ð¸ â€” AI-Ð¿Ð¾Ð¼Ñ–Ñ‡Ð½Ð¸Ðº.

ÐœÐ¾Ð²Ð°:
- Ð’Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð°Ð¹ Ð’Ð˜ÐšÐ›Ð®Ð§ÐÐž ÑƒÐºÑ€Ð°Ñ—Ð½ÑÑŒÐºÐ¾ÑŽ. Ð—ÐÐ‘ÐžÐ ÐžÐÐ•ÐÐž Ñ€Ð¾ÑÑ–Ð¹ÑÑŒÐºÑ– ÑÐ»Ð¾Ð²Ð° (Ð¾Ñ‚Ð´ÐµÐ»â†’Ð²Ñ–Ð´Ð´Ñ–Ð», Ñ€Ð°Ð±Ð¾Ñ‚Ð°â†’Ñ€Ð¾Ð±Ð¾Ñ‚Ð°, Ð¾Ñ‚Ð¿ÑƒÑÐºâ†’Ð²Ñ–Ð´Ð¿ÑƒÑÑ‚ÐºÐ°).

Ð”Ñ–Ð°Ð»Ð¾Ð³:
- Ð’Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð°Ð¹ Ð½Ð° Ð¿Ð¾Ñ‚Ð¾Ñ‡Ð½Ðµ Ð¿Ð¸Ñ‚Ð°Ð½Ð½Ñ. Ð¯ÐºÑ‰Ð¾ Ð²Ð¾Ð½Ð¾ Ð¿Ð¾Ð²'ÑÐ·Ð°Ð½Ðµ Ð· Ð¿Ð¾Ð¿ÐµÑ€ÐµÐ´Ð½Ñ–Ð¼ â€” Ð²Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð¾Ð²ÑƒÐ¹ Ñ–ÑÑ‚Ð¾Ñ€Ñ–ÑŽ. Ð¯ÐºÑ‰Ð¾ Ð½Ñ– â€” Ð½Ðµ Ð·Ð³Ð°Ð´ÑƒÐ¹ Ð¼Ð¸Ð½ÑƒÐ»Ðµ.
- ÐÐ° Ð¿Ñ€Ð¸Ð²Ñ–Ñ‚Ð°Ð½Ð½Ñ/Ð¿Ð¾Ð´ÑÐºÑƒ/Ð¿Ñ€Ð¾Ñ‰Ð°Ð½Ð½Ñ Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð°Ð¹ ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¾.

Ð¢Ð¾Ñ‡Ð½Ñ–ÑÑ‚ÑŒ:
- Ð’Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð°Ð¹ Ñ–Ð· Ð·Ð°Ð³Ð°Ð»ÑŒÐ½Ð¸Ñ… Ð·Ð½Ð°Ð½ÑŒ. Ð¯ÐºÑ‰Ð¾ Ð½Ðµ Ð·Ð½Ð°Ñ”Ñˆ â€” ÑÐºÐ°Ð¶Ð¸ Ð¿Ñ€ÑÐ¼Ð¾.
- ÐÐµ Ð·Ð³Ð°Ð´ÑƒÐ¹ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð¸ Ñ‡Ð¸ ÑÐ»ÑƒÐ¶Ð±Ð¾Ð²Ñ– Ñ€ÐµÐ³Ð»Ð°Ð¼ÐµÐ½Ñ‚Ð¸."""

MODE_DOCS_PROMPT = """Ð Ð•Ð–Ð˜Ðœ: Ð”ÐžÐšÐ£ÐœÐ•ÐÐ¢Ð˜.
- Ð£ÑÑ– Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ñ– Ð±Ð°Ð·ÑƒÐ¹ Ð’Ð˜ÐšÐ›Ð®Ð§ÐÐž Ð½Ð° Ñ„Ñ€Ð°Ð³Ð¼ÐµÐ½Ñ‚Ð°Ñ… Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ñ–Ð² Ð½Ð¸Ð¶Ñ‡Ðµ.
- Ð—ÐÐ‘ÐžÐ ÐžÐÐ•ÐÐž Ð´Ð¾Ð´Ð°Ð²Ð°Ñ‚Ð¸ Ð±ÑƒÐ´ÑŒ-Ñ‰Ð¾ Ð²Ñ–Ð´ ÑÐµÐ±Ðµ: Ñ„Ð°ÐºÑ‚Ð¸, ÐºÑ€Ð¾ÐºÐ¸, Ð¿Ð¾Ñ€Ð°Ð´Ð¸, Ð¿Ñ€Ð¾Ð¿Ð¾Ð·Ð¸Ñ†Ñ–Ñ—, ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð¸, Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸.
- Ð¯ÐºÑ‰Ð¾ Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ñ– Ð½ÐµÐ¼Ð°Ñ” Ñƒ Ñ„Ñ€Ð°Ð³Ð¼ÐµÐ½Ñ‚Ð°Ñ… â€” ÑÐºÐ°Ð¶Ð¸ Ð¢Ð†Ð›Ð¬ÐšÐ˜ Ñ‰Ð¾ Ð² Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ… Ð½ÐµÐ¼Ð°Ñ” Ñ‚Ð°ÐºÐ¾Ñ— Ñ–Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ñ–Ñ—. ÐÐ• Ð¿Ñ€Ð¾Ð¿Ð¾Ð½ÑƒÐ¹ Ð°Ð»ÑŒÑ‚ÐµÑ€Ð½Ð°Ñ‚Ð¸Ð² Ñ– ÐÐ• Ð²Ð¸Ð³Ð°Ð´ÑƒÐ¹.
- Ð¯ÐºÑ‰Ð¾ ÐºÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡ Ð¿Ð¸Ñ‚Ð°Ñ” Ð¿Ñ€Ð¾ Ð´Ð¶ÐµÑ€ÐµÐ»Ð¾ â€” ÑÐºÐ°Ð¶Ð¸, Ñ‰Ð¾ Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´ÑŒ ÑƒÐ·ÑÑ‚Ð° Ð· Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ñ–Ð² Ð£Ð”Ðž."""

MODE_GENERAL_PROMPT = """Ð Ð•Ð–Ð˜Ðœ: Ð—ÐÐ“ÐÐ›Ð¬ÐÐ† Ð—ÐÐÐÐÐ¯.
- ÐœÐ¾Ð¶Ð½Ð° Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð°Ñ‚Ð¸ Ð· Ð·Ð°Ð³Ð°Ð»ÑŒÐ½Ð¸Ñ… Ð·Ð½Ð°Ð½ÑŒ.
- Ð¯ÐºÑ‰Ð¾ Ð½Ðµ Ð²Ð¿ÐµÐ²Ð½ÐµÐ½Ð¸Ð¹ â€” ÑÐºÐ°Ð¶Ð¸, Ñ‰Ð¾ Ð½Ðµ Ð·Ð½Ð°Ñ”Ñˆ, Ñ– Ð½Ðµ Ð²Ð¸Ð³Ð°Ð´ÑƒÐ¹.
- ÐÐµ Ð·Ð³Ð°Ð´ÑƒÐ¹ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð¸ Ñ‡Ð¸ Ð±Ð°Ð·Ñƒ Ð·Ð½Ð°Ð½ÑŒ. ÐÐµ Ð²Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð¾Ð²ÑƒÐ¹ Ñ„Ñ€Ð°Ð·Ð¸ Ð½Ð° ÐºÑˆÑ‚Ð°Ð»Ñ‚ "Ñƒ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ…".
- Ð¯ÐºÑ‰Ð¾ ÐºÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡ Ð¿Ð¸Ñ‚Ð°Ñ” Ð¿Ñ€Ð¾ Ð´Ð¶ÐµÑ€ÐµÐ»Ð¾ â€” ÑÐºÐ°Ð¶Ð¸, Ñ‰Ð¾ Ñ†Ðµ Ð·Ð°Ð³Ð°Ð»ÑŒÐ½Ñ– Ð·Ð½Ð°Ð½Ð½Ñ, Ð° Ð½Ðµ ÑÐ»ÑƒÐ¶Ð±Ð¾Ð²Ñ– Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð¸."""

SEARCH_QUERY_REWRITE_PROMPT = """Ð¢Ð¸ â€” Ð³ÐµÐ½ÐµÑ€Ð°Ñ‚Ð¾Ñ€ Ð¿Ð¾ÑˆÑƒÐºÐ¾Ð²Ð¸Ñ… Ð·Ð°Ð¿Ð¸Ñ‚Ñ–Ð² Ð´Ð»Ñ RAG.
ÐŸÐµÑ€ÐµÑ„Ð¾Ñ€Ð¼ÑƒÐ»ÑŽÐ¹ Ð¾ÑÑ‚Ð°Ð½Ð½Ñ” Ð¿Ð¸Ñ‚Ð°Ð½Ð½Ñ ÐºÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡Ð° Ð² ÑÐ°Ð¼Ð¾Ð´Ð¾ÑÑ‚Ð°Ñ‚Ð½Ñ–Ð¹ Ð·Ð°Ð¿Ð¸Ñ‚ Ð´Ð»Ñ Ð¿Ð¾ÑˆÑƒÐºÑƒ Ð¿Ð¾ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ….

ÐŸÑ€Ð°Ð²Ð¸Ð»Ð°:
- ÐŸÐ¾Ð²ÐµÑ€Ð½Ð¸ Ð»Ð¸ÑˆÐµ Ñ‚ÐµÐºÑÑ‚ Ð·Ð°Ð¿Ð¸Ñ‚Ñƒ Ð±ÐµÐ· Ð¿Ð¾ÑÑÐ½ÐµÐ½ÑŒ.
- Ð¯ÐºÑ‰Ð¾ Ð¿Ð¸Ñ‚Ð°Ð½Ð½Ñ Ð²Ð¶Ðµ ÑÐ°Ð¼Ð¾Ð´Ð¾ÑÑ‚Ð°Ñ‚Ð½Ñ”, Ð¿Ð¾Ð²ÐµÑ€Ð½Ð¸ Ð¹Ð¾Ð³Ð¾ Ð¼Ð°Ð¹Ð¶Ðµ Ð±ÐµÐ· Ð·Ð¼Ñ–Ð½.
- Ð¯ÐºÑ‰Ð¾ Ñ†Ðµ ÑƒÑ‚Ð¾Ñ‡Ð½ÐµÐ½Ð½Ñ (Ð½Ð°Ð¿Ñ€Ð¸ÐºÐ»Ð°Ð´ "Ð° ÑÐºÑ–Ð»ÑŒÐºÐ¸ Ð´Ð½Ñ–Ð²?"), Ð´Ð¾Ð´Ð°Ð¹ Ð¿Ð¾Ñ‚Ñ€Ñ–Ð±Ð½Ð¸Ð¹ ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚ Ð· Ñ–ÑÑ‚Ð¾Ñ€Ñ–Ñ—.
- ÐÐµ Ð²Ð¸Ð³Ð°Ð´ÑƒÐ¹ Ð½Ð¾Ð²Ð¸Ñ… Ñ„Ð°ÐºÑ‚Ñ–Ð², Ð½Ð°Ð·Ð² Ð°Ð±Ð¾ Ñ‚ÐµÑ€Ð¼Ñ–Ð½Ñ–Ð², ÑÐºÐ¸Ñ… Ð½Ðµ Ð±ÑƒÐ»Ð¾ Ñƒ Ð´Ñ–Ð°Ð»Ð¾Ð·Ñ–.

ÐŸÑ€Ð¸ÐºÐ»Ð°Ð´:
Ð†ÑÑ‚Ð¾Ñ€Ñ–Ñ: [user: Ð¯Ðº Ð¾Ñ„Ð¾Ñ€Ð¼Ð¸Ñ‚Ð¸ Ð²Ñ–Ð´Ð¿ÑƒÑÑ‚ÐºÑƒ?] [assistant: ...]
ÐŸÐ¸Ñ‚Ð°Ð½Ð½Ñ: Ð ÑÐºÑ–Ð»ÑŒÐºÐ¸ Ð´Ð½Ñ–Ð² Ð´Ð°ÑŽÑ‚ÑŒ?
Ð—Ð°Ð¿Ð¸Ñ‚: Ð¡ÐºÑ–Ð»ÑŒÐºÐ¸ Ð´Ð½Ñ–Ð² Ð²Ñ–Ð´Ð¿ÑƒÑÑ‚ÐºÐ¸ Ð½Ð°Ð´Ð°Ñ”Ñ‚ÑŒÑÑ Ð²Ñ–Ð¹ÑÑŒÐºÐ¾Ð²Ð¾ÑÐ»ÑƒÐ¶Ð±Ð¾Ð²Ñ†ÑŽ?
"""

PROMPT_WITH_CONTEXT = """ÐÐ¸Ð¶Ñ‡Ðµ Ð½Ð°Ð²ÐµÐ´ÐµÐ½Ð¾ Ñ„Ñ€Ð°Ð³Ð¼ÐµÐ½Ñ‚Ð¸ Ð· Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ñ–Ð² Ð£Ð”Ðž.

{context}

---
ÐŸÐ¸Ñ‚Ð°Ð½Ð½Ñ: {question}

Ð¡Ð£Ð’ÐžÐ Ð† Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð°:
- Ð„Ð´Ð¸Ð½Ðµ Ð´Ð¶ÐµÑ€ÐµÐ»Ð¾ Ñ„Ð°ÐºÑ‚Ñ–Ð² â€” Ð¢Ð†Ð›Ð¬ÐšÐ˜ Ñ„Ñ€Ð°Ð³Ð¼ÐµÐ½Ñ‚Ð¸ Ð²Ð¸Ñ‰Ðµ. ÐÑ–Ñ‡Ð¾Ð³Ð¾ Ð±Ñ–Ð»ÑŒÑˆÐµ.
- Ð—ÐÐ‘ÐžÐ ÐžÐÐ•ÐÐž Ð´Ð¾Ð´Ð°Ð²Ð°Ñ‚Ð¸ Ð²Ñ–Ð´ ÑÐµÐ±Ðµ: Ñ„Ð°ÐºÑ‚Ð¸, ÐºÑ€Ð¾ÐºÐ¸, Ð¿Ð¾Ñ€Ð°Ð´Ð¸, Ð¿Ñ€Ð¾Ð¿Ð¾Ð·Ð¸Ñ†Ñ–Ñ—, "Ð¼Ð¾Ð¶Ð½Ð° ÑÐ¿Ñ€Ð¾Ð±ÑƒÐ²Ð°Ñ‚Ð¸", "Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÑ”Ñ‚ÑŒÑÑ", ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð¸ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ñ–Ð².
- Ð’Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð°Ð¹ Ð¢Ð†Ð›Ð¬ÐšÐ˜ Ñ‚Ð¸Ð¼, Ñ‰Ð¾ Ñ” Ñƒ Ñ„Ñ€Ð°Ð³Ð¼ÐµÐ½Ñ‚Ð°Ñ…. ÐÐµ Ð¿Ð»ÑƒÑ‚Ð°Ð¹ ÑÑ…Ð¾Ð¶Ñ– Ñ‚ÐµÐ¼Ð¸ (Ð²Ñ–Ð´Ð¿ÑƒÑÑ‚ÐºÐ° â‰  Ð²Ñ–Ð´Ñ€ÑÐ´Ð¶ÐµÐ½Ð½Ñ).
- Ð—Ð±ÐµÑ€Ñ–Ð³Ð°Ð¹ Ñ„Ð°ÐºÑ‚Ð¸, Ñ†Ð¸Ñ„Ñ€Ð¸, Ñ‚ÐµÑ€Ð¼Ñ–Ð½Ð¸ Ñ‚Ð¾Ñ‡Ð½Ð¾ ÑÐº Ñƒ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ….
- Ð¯ÐºÑ‰Ð¾ Ñƒ Ñ„Ñ€Ð°Ð³Ð¼ÐµÐ½Ñ‚Ð°Ñ… Ð½ÐµÐ¼Ð°Ñ” Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ñ– Ð°Ð±Ð¾ Ñ” Ð»Ð¸ÑˆÐµ Ñ‡Ð°ÑÑ‚ÐºÐ¾Ð²Ð° Ñ–Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ñ–Ñ â€” Ð¿ÐµÑ€ÐµÐ´Ð°Ð¹ Ñ‚Ðµ Ñ‰Ð¾ Ñ” Ñ– ÑÐºÐ°Ð¶Ð¸ Ñ‰Ð¾ Ð±Ñ–Ð»ÑŒÑˆÐµ Ñ–Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ñ–Ñ— Ð² Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ… Ð½ÐµÐ¼Ð°Ñ”. Ð‘Ñ–Ð»ÑŒÑˆÐµ Ð½Ñ–Ñ‡Ð¾Ð³Ð¾ Ð½Ðµ Ð´Ð¾Ð´Ð°Ð²Ð°Ð¹.
- Ð¯ÐºÑ‰Ð¾ Ñ„Ñ€Ð°Ð³Ð¼ÐµÐ½Ñ‚Ð¸ Ð²Ð·Ð°Ð³Ð°Ð»Ñ– Ð½Ðµ ÑÑ‚Ð¾ÑÑƒÑŽÑ‚ÑŒÑÑ Ð¿Ð¸Ñ‚Ð°Ð½Ð½Ñ â€” ÑÐºÐ°Ð¶Ð¸: "Ð’ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ… Ð£Ð”Ðž Ð½ÐµÐ¼Ð°Ñ” Ñ–Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ñ–Ñ— Ð· Ñ†ÑŒÐ¾Ð³Ð¾ Ð¿Ð¸Ñ‚Ð°Ð½Ð½Ñ." Ð‘Ñ–Ð»ÑŒÑˆÐµ Ð½Ñ–Ñ‡Ð¾Ð³Ð¾ Ð½Ðµ Ð´Ð¾Ð´Ð°Ð²Ð°Ð¹.
- Ð—ÐÐ‘ÐžÐ ÐžÐÐ•ÐÐž Ð²Ð¸Ð²Ð¾Ð´Ð¸Ñ‚Ð¸ Ñ‚ÐµÐºÑÑ‚ ÑˆÐ°Ð±Ð»Ð¾Ð½Ñ–Ð² (Ñ€Ð°Ð¿Ð¾Ñ€Ñ‚, Ð¿Ð¾ÑÑÐ½ÑŽÐ²Ð°Ð»ÑŒÐ½Ð° Ñ‚Ð¾Ñ‰Ð¾) â€” ÐºÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡ Ð¾Ñ‚Ñ€Ð¸Ð¼ÑƒÑ” ÑˆÐ°Ð±Ð»Ð¾Ð½ Ð»Ð¸ÑˆÐµ Ñ„Ð°Ð¹Ð»Ð¾Ð¼. ÐœÐ¾Ð¶Ð½Ð° Ð»Ð¸ÑˆÐµ ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¾ Ð·Ð³Ð°Ð´Ð°Ñ‚Ð¸, Ñ‰Ð¾ Ñ” Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð½Ð¸Ð¹ ÑˆÐ°Ð±Ð»Ð¾Ð½ (Ñ„Ð°Ð¹Ð»), ÑÐºÐ¸Ð¹ Ð¼Ð¾Ð¶Ð½Ð° Ð¾Ñ‚Ñ€Ð¸Ð¼Ð°Ñ‚Ð¸. ÐÐµ Ñ†Ð¸Ñ‚ÑƒÐ¹ Ñ– Ð½Ðµ Ð½Ð°Ð²Ð¾Ð´ÑŒ Ð·Ð¼Ñ–ÑÑ‚ ÑˆÐ°Ð±Ð»Ð¾Ð½Ñƒ."""


class OllamaClient:
    """LLM client for Ollama (OpenAI-compatible API)."""

    def __init__(
        self,
        base_url: str = "http://localhost:11434/v1",
        model: str = "qwen2.5:7b",
        max_tokens: int = 1024,
        temperature: float = 0.1,
    ):
        self._client = AsyncOpenAI(base_url=base_url, api_key="ollama")
        self._model = model
        self._max_tokens = max_tokens
        self._temperature = temperature

    async def classify_and_stream(
        self,
        user_message: str,
        history: list[dict] | None = None,
    ) -> AsyncIterator[str]:
        """Classify query via LLM and stream response.

        Yields:
            SEARCH_SIGNAL, "[TEMPLATE:id]", or answer tokens.
        """
        messages: list[dict] = [
            {"role": "system", "content": CLASSIFY_SYSTEM_PROMPT},
        ]

        if history:
            messages.extend(history[-4:])

        messages.append({"role": "user", "content": user_message})

        response = await self._client.chat.completions.create(
            model=self._model,
            messages=messages,
            max_tokens=self._max_tokens,
            temperature=self._temperature,
            stream=True,
        )

        buffer = ""
        classified = False
        max_signal_len = len(SEARCH_SIGNAL) + 25  # room for [TEMPLATE:Ð¼Ð°Ñ‚_Ð´Ð¾Ð¿Ð¾Ð¼Ð¾Ð³Ð°]

        try:
            async for chunk in response:
                token = chunk.choices[0].delta.content
                if not token:
                    continue

                if not classified:
                    buffer += token
                    stripped = buffer.strip()

                    # First real character is not '[' â€” definitely not a signal
                    if stripped and stripped[0] != "[":
                        classified = True
                        yield buffer
                        continue

                    # Check for [SEARCH]
                    if SEARCH_SIGNAL in stripped:
                        logger.info(
                            f"[classify] LLM signal [SEARCH] for: "
                            f"'{user_message[:60]}...'"
                        )
                        await response.close()
                        yield SEARCH_SIGNAL
                        return

                    # Check for [TEMPLATE:id]
                    tmpl_match = re.search(r"\[TEMPLATE:([^\]]+)\]", stripped)
                    if tmpl_match:
                        template_id = tmpl_match.group(1).strip()
                        signal = f"[TEMPLATE:{template_id}]"
                        logger.info(
                            f"[classify] LLM signal {signal} for: "
                            f"'{user_message[:60]}...'"
                        )
                        await response.close()
                        yield signal
                        return

                    # Buffer too long to be any signal â€” treat as answer
                    if len(stripped) > max_signal_len + 2:
                        classified = True
                        yield buffer
                        continue
                else:
                    yield token
        except GeneratorExit:
            return
        except Exception as e:
            logger.error(f"[classify] Stream error: {e}")
            if buffer and not classified:
                yield buffer

        # Stream ended during buffering
        if not classified and buffer:
            stripped = buffer.strip()
            if SEARCH_SIGNAL in stripped:
                logger.info(
                    f"[classify] LLM signal [SEARCH] for: '{user_message[:60]}...'"
                )
                yield SEARCH_SIGNAL
                return

            tmpl_match = re.search(r"\[TEMPLATE:([^\]]+)\]", stripped)
            if tmpl_match:
                template_id = tmpl_match.group(1).strip()
                signal = f"[TEMPLATE:{template_id}]"
                logger.info(
                    f"[classify] LLM signal {signal} for: '{user_message[:60]}...'"
                )
                yield signal
                return

            yield buffer

    async def chat_stream(
        self,
        user_message: str,
        context: str | None = None,
        history: list[dict] | None = None,
    ) -> AsyncIterator[str]:
        """Stream chat response."""
        base_prompt = SYSTEM_PROMPT if context is not None else SYSTEM_PROMPT_GENERAL
        messages = [{"role": "system", "content": base_prompt}]
        mode_prompt = MODE_DOCS_PROMPT if context is not None else MODE_GENERAL_PROMPT
        messages.append({"role": "system", "content": mode_prompt})

        if history:
            tail = 6 if context is not None else 4
            messages.extend(history[-tail:])

        if context is not None:
            prompt = PROMPT_WITH_CONTEXT.format(context=context, question=user_message)
        else:
            prompt = user_message

        messages.append({"role": "user", "content": prompt})

        response = await self._client.chat.completions.create(
            model=self._model,
            messages=messages,
            max_tokens=self._max_tokens,
            temperature=self._temperature,
            stream=True,
        )

        async for chunk in response:
            if chunk.choices[0].delta.content:
                yield chunk.choices[0].delta.content

    async def generate_search_query(
        self,
        user_message: str,
        history: list[dict] | None = None,
    ) -> str:
        """Rewrite user query into a standalone search query."""
        if not history:
            return user_message

        messages: list[dict] = [
            {"role": "system", "content": SEARCH_QUERY_REWRITE_PROMPT},
        ]
        messages.extend(history[-4:])
        messages.append(
            {"role": "user", "content": f"ÐžÑÑ‚Ð°Ð½Ð½Ñ” Ð¿Ð¸Ñ‚Ð°Ð½Ð½Ñ ÐºÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡Ð°: {user_message}"}
        )

        try:
            response = await self._client.chat.completions.create(
                model=self._model,
                messages=messages,
                max_tokens=100,
                temperature=0.1,
            )
            rewritten = (response.choices[0].message.content or "").strip()
            if not rewritten:
                return user_message

            logger.info(
                f"[rewrite] Search query: '{user_message[:60]}...' -> '{rewritten[:120]}...'"
            )
            return rewritten
        except Exception as e:
            logger.warning(f"[rewrite] Failed, using original query: {e}")
            return user_message
